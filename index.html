<!doctype html>
<html>
	<head>
		<meta charset="utf8">
		<title>IkOn db</title>
		<link rel="stylesheet" type="text/css" href="style.css">
		<script src="/libs/sql-wasm.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	</head>

	<body>

        <div id="app">
        	<header>
        		<div id="status-box">
        			<span v-if="loaded">connected</span>
					<span class="warning" v-else>connecting to database...</span>
				</div>
				<h1>Ikon DB</h1>
				
			</header>

            <div class="tables">
            	<section>
            		<h3>exhibitions</h3>
            		<input v-model="query_exhibition" placeholder="find by title">
		            <table>
		                <thead>
		                	<tr>
		                		<td>id</td>
		                		<td>title</td>
		                		<td>date</td>
		                		<td>gallery</td>
		                		<td>artists</td>
		                	</tr>
		                </thead>
		                <body>
							  <tr v-for="_ in exhibitions">
							    <td>{{ _.id }}</td>
							    <td>{{ _.title }}</td>
							    <td>{{ _.date }}</td>
							    <td>{{ _.gallery_id }}</td>
							    <td>{{ _.artists }}</td>
							  </tr>

		                </body>
		            </table>
		        </section>
            	<section>
            		<h3>galleries</h3>
            		<input v-model="query_gallery" placeholder="find by name">
		            <table>
		                <thead>
		                	<tr>
		                		<td>id</td>
		                		<td>name</td>
		                	</tr>
		                </thead>
		                <body>
							  <tr v-for="_ in galleries">
							    <td>{{ _.id }}</td>
							    <td>{{ _.name }}</td>
							  </tr>
		                </body>
		            </table>
		        </section>

            	<section>
            		<h3>artists</h3>
            		<input v-model="query_artist" placeholder="find by name">
		            <table>
		                <thead>
		                	<tr>
		                		<td>id</td>
		                		<td>name</td>
		                	</tr>
		                </thead>
		                <body>
							  <tr v-for="_ in artists">
							    <td>{{ _.id }}</td>
							    <td>{{ _.name }}</td>
							  </tr>

		                </body>
		            </table>
		        </section>
	        </div>
        </div>
		<script>
			var db;
			var app;

			app = new Vue({
			  el: '#app',
			  data: {
			  	query_exhibition: "",
			  	query_gallery: "",
			  	query_artist: "",
			  	loaded: false,
			  },
			  computed:{
			    exhibitions: function(){
			    	if(this.loaded){
			    		return getExhibitionsTable(db, this.query_exhibition);
			    	}else{
			    		return [];
			    	}
			    },
			    artists: function(){
			    	if(this.loaded){
			    		return getArtistsTable(db, this.query_artist);
			    	}else{
			    		return [];
			    	}
			    },
			    galleries: function(){
			    	if(this.loaded){
			    		return getGalleriesTable(db, this.query_gallery);
			    	}else{
			    		return [];
			    	}
			    }
			  }
			});


			function getExhibitionsTable(db, query){
				let contents = db.exec("SELECT id, title, gallery_id, date FROM exhibitions WHERE title LIKE '"+"%"+query+"%"+"'");
				items = []
				if(contents.length==0)
					return []

				for(row of contents[0].values){
					items.push({
						id: row[0],
						title: row[1],
						date: row[3]
					});
				}
				return items;
			}

			function getArtistsTable(db, query){
				let contents = db.exec("SELECT id, name FROM artists WHERE name LIKE '"+"%"+query+"%"+"'");
				items = []
				if(contents.length==0)
					return []

				for(row of contents[0].values){
					items.push({
						id: row[0],
						name: row[1]
					});
				}
				return items;
			}

			function getGalleriesTable(db, query){
				let contents = db.exec("SELECT id, name FROM galleries WHERE name LIKE '"+"%"+query+"%"+"'");
				items = []
				if(contents.length==0)
					return []

				for(row of contents[0].values){
					items.push({
						id: row[0],
						name: row[1]
					});
				}
				return items;
			}

			function onDBLoad(database){
				db = database;
				app.loaded=true;
			}

			// load database
			config = {
		    	locateFile: filename => `/libs/${filename}` 
		    }
		    initSqlJs(config).then(function(SQL){
		    	var xhr = new XMLHttpRequest();
					xhr.open('GET', 'ikon.db', true);
					xhr.responseType = 'arraybuffer';

					xhr.onload = function(e) {
					  var uInt8Array = new Uint8Array(this.response);
					  var db = new SQL.Database(uInt8Array);
					  onDBLoad(db);  
					};
					xhr.send();
		    	var db = new SQL.Database();
		    });


		</script>
	</body>
	</html>